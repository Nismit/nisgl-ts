<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>GPGPU | NISGL Example</title>
  <link rel="icon" type="image/x-icon" href="./assets/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>body { margin: 0; overflow: hidden; }</style>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90679064-4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-90679064-4');
  </script>
</head>
<body id="triangle">
  <canvas id="canvas"></canvas>
  <script type="module">
    import NISGL from "./assets/nisgl.module.js";
    import { mat4 } from "https://cdn.jsdelivr.net/npm/gl-matrix@3.4.3/esm/index.js";

    const DefaultVertex = `
    attribute vec3 position;
    void main(){
      gl_Position = vec4(position, 1.0);
    }`;

    const DefaultFragment = `
    precision mediump float;
    uniform vec2 resolution;
    void main(){
      vec2 p = (gl_FragCoord.xy / resolution) * 2.0 - 1.0;
      gl_FragColor = vec4(p, 0.0, 0.0);
    }`;

    const VelocityVertex = `
    attribute vec3 position;
    void main(){
      gl_Position = vec4(position, 1.0);
    }`;

    const VelocityFragment = `
    precision mediump float;
    uniform vec2 resolution;
    uniform sampler2D texture;
    uniform vec2 mouse;
    uniform bool mouseFlag;
    uniform float velocity;
    const float SPEED = 0.05;
    void main(){
      vec2 p = gl_FragCoord.xy / resolution; // texture coordinate
      vec4 t = texture2D(texture, p); // previous frame coordinate
      vec2 v = normalize(mouse - t.xy) * 0.2; // vector to the cursor
      vec2 w = normalize(v + t.zw); // direction
      vec4 destColor = vec4(t.xy + w * SPEED * velocity, w);
      if(!mouseFlag){destColor.zw = t.zw;}
      gl_FragColor = destColor;
    }`;

    const PointVertex = `
    attribute float index;
    uniform vec2 resolution;
    uniform sampler2D texture;
    uniform float pointScale;
    void main(){
      vec2 p = vec2(
        mod(index, resolution.x) / resolution.x,
        floor(index / resolution.x) / resolution.y
      );
      vec4 t = texture2D(texture, p);
      gl_Position  = vec4(t.xy, 0.0, 1.0);
      gl_PointSize = 1.5 + pointScale;
    }`;

    const PointFragment = `
    precision mediump float;
    uniform vec4 ambient;
    void main(){
      gl_FragColor = ambient;
    }`;

    const canvas = document.querySelector("#canvas");
    canvas.width = document.documentElement.clientWidth;
    canvas.height = window.innerHeight;
    const gl = canvas.getContext("webgl");
    const nisgl = new NISGL(gl);

    // Enable extension
    const ext = gl.getExtension('OES_texture_float') || gl.getExtension('OES_texture_half_float');
    if (ext == null) {
      alert('float texture not supported');
    }

    // Event
    let mouseFlag = false;
    let mousePositionX = 0.0;
    let mousePositionY = 0.0;
    canvas.addEventListener('mousedown', mouseDown, true);
    canvas.addEventListener('mouseup', mouseUp, true);
    canvas.addEventListener('mousemove', mouseMove, true);

    // Clear
    nisgl.clear();

    // Data
    const position_data = [
      -1.0,  1.0,  0.0,
      -1.0, -1.0,  0.0,
      1.0,  1.0,  0.0,
      1.0, -1.0,  0.0
    ];

    const TEX_WIDTH = 512;
    const TEX_HEIGHT = 512;
    const index_data = new Array(TEX_WIDTH * TEX_HEIGHT);
    for(let i = 0; i < index_data.length; i++) {
      index_data[i] = i;
    }

    // Create a program
    const defaultProgram = nisgl.createProgram(DefaultVertex, DefaultFragment);
    const velocityProgram = nisgl.createProgram(VelocityVertex, VelocityFragment);
    const pointProgram = nisgl.createProgram(PointVertex, PointFragment);

    const positionBuffer = nisgl.arrayBuffer(new Float32Array(position_data));
    positionBuffer.attrib("position", 3);
    const indexBuffer = nisgl.arrayBuffer(new Float32Array(index_data));
    indexBuffer.attrib("index", 1);

     // Uniforms
    let velocity = 0;
    let counter = 0;
    let ambient = [];

    // Framebuffer
    let backBuffer = nisgl.createFrameBuffer(TEX_WIDTH, TEX_HEIGHT);
    backBuffer.attachTexture(gl.FLOAT, true);
    let frontBuffer = nisgl.createFrameBuffer(TEX_WIDTH, TEX_HEIGHT);
    frontBuffer.attachTexture(gl.FLOAT, true);
    let flipBuffer = null;

    gl.activeTexture(gl.TEXTURE0);
    gl.disable(gl.BLEND);
    gl.blendFunc(gl.ONE, gl.ONE);

    // Init backBuffer
    backBuffer.bind();
    gl.viewport(0, 0, TEX_WIDTH, TEX_HEIGHT);
    nisgl.clear();
    defaultProgram.use();
    positionBuffer.attribPointer(defaultProgram);
    defaultProgram.setUniform("2fv", "resolution", [TEX_WIDTH, TEX_HEIGHT]);
    positionBuffer.drawTriangleStrips(0, position_data.length / 3);

    function render() {
      // Front Buffer
      gl.disable(gl.BLEND);
      frontBuffer.bind();
      nisgl.clear();
      gl.viewport(0, 0, TEX_WIDTH, TEX_HEIGHT);

      velocityProgram.use();
      positionBuffer.attribPointer(velocityProgram);

      const backTex = backBuffer.getTexture();
      backTex.bind();

      velocityProgram.setUniform("2fv", "resolution", [TEX_WIDTH, TEX_HEIGHT]);
      velocityProgram.setUniform("1i", "texture", 0);
      velocityProgram.setUniform("2fv", "mouse", [mousePositionX, mousePositionY]);
      velocityProgram.setUniform("1i", "mouseFlag", mouseFlag);
      velocityProgram.setUniform("1f", "velocity", velocity);
      positionBuffer.drawTriangleStrips(0, position_data.length / 3);

      counter++;
      ambient = hsva(counter % 360, 1.0, 0.8, 1.0);

      gl.enable(gl.BLEND);
      gl.viewport(0, 0, canvas.width, canvas.height);
      frontBuffer.unbind();
      nisgl.clear();

      pointProgram.use();
      const frontTex = frontBuffer.getTexture();
      frontTex.bind();

      indexBuffer.attribPointer(pointProgram);
      pointProgram.setUniform("2fv", "resolution", [TEX_WIDTH, TEX_HEIGHT]);
      pointProgram.setUniform("1i", "texture", 0);
      pointProgram.setUniform("1f", "velocity", velocity);
      pointProgram.setUniform("4fv", "ambient", ambient);
      indexBuffer.drawPoints(0, index_data.length);

      nisgl.flush();

      if (mouseFlag) {
        velocity = 1.0;
      } else {
        velocity *= 0.95;
      }

      flipBuffer = backBuffer;
      backBuffer = frontBuffer;
      frontBuffer = flipBuffer;
    }

    function renderLoop() {
      render();
      requestAnimationFrame(renderLoop);
    }
    renderLoop();

    function mouseDown(eve){
      mouseFlag = true;
    }

    function mouseUp(eve){
      mouseFlag = false;
    }

    function mouseMove(eve){
      if(mouseFlag){
        var cw = canvas.width;
        var ch = canvas.height;
        mousePositionX = (eve.clientX - canvas.offsetLeft - cw / 2.0) / cw * 2.0;
        mousePositionY = -(eve.clientY - canvas.offsetTop - ch / 2.0) / ch * 2.0;
      }
    }

    function keyDown(eve){
      run = (eve.keyCode !== 27);
    }

    function hsva(h, s, v, a){
      if(s > 1 || v > 1 || a > 1){return;}
      var th = h % 360;
      var i = Math.floor(th / 60);
      var f = th / 60 - i;
      var m = v * (1 - s);
      var n = v * (1 - s * f);
      var k = v * (1 - s * (1 - f));
      var color = new Array();
      if(!s > 0 && !s < 0){
        color.push(v, v, v, a);
      } else {
        var r = new Array(v, n, m, m, k, v);
        var g = new Array(k, v, v, n, m, m);
        var b = new Array(m, m, k, v, v, n);
        color.push(r[i], g[i], b[i], a);
      }
      return color;
    }
  </script>
</body>
</html>
